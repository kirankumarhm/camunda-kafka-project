# Camunda Workflow with Multi-Instance Correlation of Kafka Responses

## Problem Statement

How can a Camunda workflow with a multi-instance task and multiple sub-service tasks reliably correlate Kafka responses to the correct instance of the originating sub-service task based on a composite ID?

### More Detailed

Design and implement a Camunda workflow with a multi-instance task containing several sub-service tasks. One sub-service task publishes messages to a Kafka topic, including a composite ID (e.g., `wf_ID_sub_task_ID_12345`) derived from the workflow instance ID. The challenge is to efficiently and accurately route responses received from a separate Kafka topic back to the corresponding instance of the originating sub-service task, ensuring correct processing by a subsequent sub-service task.

![multi-instance](image.png)

![sub-task correlate Kafka response](image-1.png)

#### 1. Design the Workflow Model

- **Multi-Instance Task**: Create a multi-instance task in Camunda that will handle multiple sub-service tasks.
- **Sub-Service Tasks**: Define the sub-service tasks within the multi-instance task. Each sub-service task will publish a message to a Kafka topic.

#### 2. Generate Composite ID

- **Composite ID Structure**: Define a composite ID structure, e.g., `wf_ID_sub_task_ID_12345`, where `wf_ID` is the workflow instance ID and `sub_task_ID` is the sub-service task ID.
- **Assign Composite ID**: Assign this composite ID to each message published to the Kafka topic by the sub-service tasks.

#### 3. Publish Messages to Kafka

- **Kafka Producer**: Implement a Kafka producer in each sub-service task to publish messages to a Kafka topic. Include the composite ID in the message payload.

#### 4. Set Up Kafka Consumer

- **Kafka Consumer**: Implement a Kafka consumer that listens to the response topic.
- **Message Parsing**: Parse the incoming messages to extract the composite ID.

#### 5. Correlate Responses

- **Correlation Logic**: Implement logic to correlate the responses based on the composite ID. This can be done using Camunda’s message correlation feature.
- **Message Correlation**: Use the composite ID to correlate the response message to the correct instance of the originating sub-service task.

#### 6. Process the Correlated Message

- **Subsequent Sub-Service Task**: Once the message is correlated, ensure it is processed by the subsequent sub-service task in the workflow.

## Implementation Details

### 1. Camunda Workflow Configuration

- Define the multi-instance task and sub-service tasks in the BPMN model.
- Configure the message correlation in the BPMN model using the composite ID.

### 2. Kafka Producer Implementation

- Use a Kafka client library (e.g., Apache Kafka, Spring Kafka) to implement the producer.
- Ensure the composite ID is included in the message payload.

```java
ProducerRecord<String, String> record = new ProducerRecord<>("topicName", compositeID, messagePayload);
producer.send(record);
```

### 3. Kafka Consumer Implementation

- Use a Kafka client library to implement the consumer.
- Extract the composite ID from the incoming messages.

### 4. Message Correlation in Camunda

- Use Camunda’s Java API or BPMN model to correlate messages based on the composite ID.

### Example Code

#### Java

```java
runtimeService.createMessageCorrelation(compositeID)
        .processInstanceVariableEquals("compositeID", compositeID)
        .setVariable("correlatedPayload", msg.getPayload())
        .correlate();
```
